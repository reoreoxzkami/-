<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC ãƒ“ãƒ‡ã‚ªé€šè©±ã‚¢ãƒ—ãƒª</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f1f5f9;
        --panel: #ffffff;
        --text: #0f172a;
        --muted: #475569;
        --border: #dbe4f0;
        --accent: #2563eb;
        --accent-dark: #1d4ed8;
        --ok: #16a34a;
        --danger: #dc2626;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
        background: radial-gradient(circle at top, #f8fafc, var(--bg));
        color: var(--text);
      }

      .app {
        width: min(1100px, 96vw);
        margin: 22px auto;
        display: grid;
        gap: 16px;
      }

      h1 {
        margin: 0;
        font-size: clamp(22px, 3vw, 34px);
      }

      .subtitle {
        margin: 8px 0 0;
        color: var(--muted);
        font-size: 14px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      }

      .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 12px;
      }

      .video-card {
        display: grid;
        gap: 8px;
      }

      .video-card h2 {
        margin: 0;
        font-size: 15px;
      }

      video {
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #0f172a;
        border-radius: 12px;
        border: 1px solid #c7d2e1;
        object-fit: cover;
      }

      .controls,
      .signal-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      button {
        border: 1px solid var(--border);
        background: #fff;
        color: var(--text);
        padding: 8px 12px;
        border-radius: 9px;
        font-size: 14px;
        cursor: pointer;
      }

      button:hover {
        border-color: #b4c5dc;
      }

      button.primary {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent-dark);
      }

      button.danger {
        color: var(--danger);
        border-color: #fecaca;
        background: #fff5f5;
      }

      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      label {
        font-weight: 700;
        font-size: 13px;
      }

      textarea {
        width: 100%;
        min-height: 128px;
        border-radius: 9px;
        border: 1px solid var(--border);
        padding: 10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        resize: vertical;
      }

      .signal-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
      }

      .status {
        margin: 0;
        font-size: 14px;
        color: var(--ok);
      }

      .note {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
      }

      @media (max-width: 840px) {
        .signal-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <section class="panel">
        <h1>ğŸ“¹ WebRTC ãƒ“ãƒ‡ã‚ªé€šè©±ã‚¢ãƒ—ãƒª</h1>
        <p class="subtitle">2ã¤ã®ãƒ–ãƒ©ã‚¦ã‚¶é–“ã§ã€æ‰‹å‹•ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ï¼ˆã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆï¼‰ã§æ¥ç¶šã§ãã¾ã™ã€‚</p>
      </section>

      <section class="panel video-grid" aria-label="ãƒ“ãƒ‡ã‚ªè¡¨ç¤º">
        <article class="video-card">
          <h2>ã‚ãªãŸã®æ˜ åƒ</h2>
          <video id="localVideo" autoplay muted playsinline></video>
        </article>
        <article class="video-card">
          <h2>ç›¸æ‰‹ã®æ˜ åƒ</h2>
          <video id="remoteVideo" autoplay playsinline></video>
        </article>
      </section>

      <section class="panel" aria-label="åŸºæœ¬æ“ä½œ">
        <div class="controls">
          <button id="startBtn" class="primary" type="button">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
          <button id="createOfferBtn" type="button" disabled>ã‚ªãƒ•ã‚¡ãƒ¼ä½œæˆ</button>
          <button id="hangupBtn" class="danger" type="button" disabled>åˆ‡æ–­</button>
          <button id="toggleAudioBtn" type="button" disabled>ãƒã‚¤ã‚¯OFF</button>
          <button id="toggleVideoBtn" type="button" disabled>ã‚«ãƒ¡ãƒ©OFF</button>
        </div>
        <p id="status" class="status">æº–å‚™å®Œäº†ï¼šã¾ãšã€Œã‚«ãƒ¡ãƒ©é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
      </section>

      <section class="panel" aria-label="ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°">
        <div class="signal-grid">
          <article>
            <label for="outgoingSignal">é€ä¿¡ç”¨ã‚·ã‚°ãƒŠãƒ«ï¼ˆã‚³ãƒ”ãƒ¼ã—ã¦ç›¸æ‰‹ã«é€ã‚‹ï¼‰</label>
            <textarea id="outgoingSignal" readonly placeholder="ã“ã“ã«Offer / Answer / ICEå€™è£œãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
            <div class="signal-actions">
              <button id="copyBtn" type="button">ã‚³ãƒ”ãƒ¼</button>
              <button id="createAnswerBtn" type="button" disabled>å—ä¿¡SDPã‹ã‚‰ã‚¢ãƒ³ã‚µãƒ¼ä½œæˆ</button>
            </div>
          </article>
          <article>
            <label for="incomingSignal">å—ä¿¡ã‚·ã‚°ãƒŠãƒ«ï¼ˆç›¸æ‰‹ã‹ã‚‰å—ã‘å–ã£ã¦è²¼ã‚Šä»˜ã‘ã‚‹ï¼‰</label>
            <textarea id="incomingSignal" placeholder='ä¾‹: {"sdp":{...},"candidates":[...]}'></textarea>
            <div class="signal-actions">
              <button id="applyBtn" class="primary" type="button" disabled>å—ä¿¡ã‚·ã‚°ãƒŠãƒ«ã‚’é©ç”¨</button>
              <p class="note">ã‚³ãƒ„: ç‰‡æ–¹ã§ã‚ªãƒ•ã‚¡ãƒ¼ä½œæˆ â†’ ã‚‚ã†ç‰‡æ–¹ã§é©ç”¨ï¼†ã‚¢ãƒ³ã‚µãƒ¼ä½œæˆ â†’ æœ€å¾Œã«ã‚ªãƒ•ã‚¡ãƒ¼å´ã§ã‚¢ãƒ³ã‚µãƒ¼é©ç”¨ã€‚</p>
            </div>
          </article>
        </div>
      </section>
    </div>

    <script>
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const startBtn = document.getElementById("startBtn");
      const createOfferBtn = document.getElementById("createOfferBtn");
      const createAnswerBtn = document.getElementById("createAnswerBtn");
      const applyBtn = document.getElementById("applyBtn");
      const hangupBtn = document.getElementById("hangupBtn");
      const toggleAudioBtn = document.getElementById("toggleAudioBtn");
      const toggleVideoBtn = document.getElementById("toggleVideoBtn");
      const copyBtn = document.getElementById("copyBtn");
      const outgoingSignal = document.getElementById("outgoingSignal");
      const incomingSignal = document.getElementById("incomingSignal");
      const statusText = document.getElementById("status");

      const rtcConfig = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      };

      let localStream = null;
      let peerConnection = null;
      let gatheredCandidates = [];
      let isAudioEnabled = true;
      let isVideoEnabled = true;

      function setStatus(message, isError = false) {
        statusText.textContent = message;
        statusText.style.color = isError ? "#dc2626" : "#16a34a";
      }

      function updateButtons() {
        const hasStream = Boolean(localStream);
        const hasPeer = Boolean(peerConnection);
        startBtn.disabled = hasStream;
        createOfferBtn.disabled = !hasPeer;
        createAnswerBtn.disabled = !hasPeer;
        applyBtn.disabled = !hasPeer;
        hangupBtn.disabled = !hasPeer;
        toggleAudioBtn.disabled = !hasStream;
        toggleVideoBtn.disabled = !hasStream;
      }

      function buildSignalPayload() {
        if (!peerConnection || !peerConnection.localDescription) {
          return;
        }

        const payload = {
          sdp: peerConnection.localDescription,
          candidates: gatheredCandidates
        };

        outgoingSignal.value = JSON.stringify(payload, null, 2);
      }

      function createPeerConnection() {
        peerConnection = new RTCPeerConnection(rtcConfig);
        gatheredCandidates = [];

        peerConnection.addEventListener("icecandidate", (event) => {
          if (event.candidate) {
            gatheredCandidates.push(event.candidate.toJSON());
          }

          if (!event.candidate) {
            buildSignalPayload();
            setStatus("ã‚·ã‚°ãƒŠãƒ«ç”Ÿæˆå®Œäº†ã€‚ã‚³ãƒ”ãƒ¼ã—ã¦ç›¸æ‰‹ã«é€ã£ã¦ãã ã•ã„ã€‚");
          }
        });

        peerConnection.addEventListener("track", (event) => {
          if (!remoteVideo.srcObject) {
            remoteVideo.srcObject = event.streams[0];
          }
        });

        peerConnection.addEventListener("connectionstatechange", () => {
          if (peerConnection.connectionState === "connected") {
            setStatus("æ¥ç¶šæˆåŠŸï¼ãƒ“ãƒ‡ã‚ªé€šè©±ä¸­ã§ã™ã€‚");
          } else if (peerConnection.connectionState === "failed") {
            setStatus("æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ã‚°ãƒŠãƒ«ã‚’å†ä½œæˆã—ã¦ãã ã•ã„ã€‚", true);
          }
        });
      }

      async function startMedia() {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
          });

          localVideo.srcObject = localStream;
          createPeerConnection();

          localStream.getTracks().forEach((track) => {
            peerConnection.addTrack(track, localStream);
          });

          setStatus("ã‚«ãƒ¡ãƒ©é–‹å§‹å®Œäº†ã€‚ã‚ªãƒ•ã‚¡ãƒ¼ä½œæˆã¾ãŸã¯å—ä¿¡ã‚·ã‚°ãƒŠãƒ«é©ç”¨ãŒã§ãã¾ã™ã€‚");
          updateButtons();
        } catch (error) {
          setStatus("ã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯ã®åˆ©ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", true);
          console.error(error);
        }
      }

      async function createOffer() {
        try {
          gatheredCandidates = [];
          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);
          setStatus("ã‚ªãƒ•ã‚¡ãƒ¼ä½œæˆä¸­... ICEå€™è£œã‚’åé›†ä¸­ã§ã™ã€‚");
        } catch (error) {
          setStatus("ã‚ªãƒ•ã‚¡ãƒ¼ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
          console.error(error);
        }
      }

      async function createAnswer() {
        try {
          const payload = JSON.parse(incomingSignal.value);

          if (!payload.sdp || payload.sdp.type !== "offer") {
            setStatus("å—ä¿¡ã‚·ã‚°ãƒŠãƒ«ã« offer ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", true);
            return;
          }

          gatheredCandidates = [];
          await peerConnection.setRemoteDescription(payload.sdp);

          if (Array.isArray(payload.candidates)) {
            for (const candidate of payload.candidates) {
              await peerConnection.addIceCandidate(candidate);
            }
          }

          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          setStatus("ã‚¢ãƒ³ã‚µãƒ¼ä½œæˆä¸­... ICEå€™è£œã‚’åé›†ä¸­ã§ã™ã€‚");
        } catch (error) {
          setStatus("ã‚¢ãƒ³ã‚µãƒ¼ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", true);
          console.error(error);
        }
      }

      async function applyIncomingSignal() {
        try {
          const payload = JSON.parse(incomingSignal.value);

          if (!payload.sdp) {
            setStatus("å—ä¿¡ã‚·ã‚°ãƒŠãƒ«ã« sdp ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", true);
            return;
          }

          await peerConnection.setRemoteDescription(payload.sdp);

          if (Array.isArray(payload.candidates)) {
            for (const candidate of payload.candidates) {
              await peerConnection.addIceCandidate(candidate);
            }
          }

          setStatus(`å—ä¿¡ã‚·ã‚°ãƒŠãƒ«ã‚’é©ç”¨ã—ã¾ã—ãŸï¼ˆ${payload.sdp.type}ï¼‰ã€‚`);
        } catch (error) {
          setStatus("å—ä¿¡ã‚·ã‚°ãƒŠãƒ«ã®é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", true);
          console.error(error);
        }
      }

      function toggleAudio() {
        const audioTracks = localStream ? localStream.getAudioTracks() : [];
        if (audioTracks.length === 0) {
          return;
        }

        isAudioEnabled = !isAudioEnabled;
        audioTracks.forEach((track) => {
          track.enabled = isAudioEnabled;
        });
        toggleAudioBtn.textContent = isAudioEnabled ? "ãƒã‚¤ã‚¯OFF" : "ãƒã‚¤ã‚¯ON";
      }

      function toggleVideo() {
        const videoTracks = localStream ? localStream.getVideoTracks() : [];
        if (videoTracks.length === 0) {
          return;
        }

        isVideoEnabled = !isVideoEnabled;
        videoTracks.forEach((track) => {
          track.enabled = isVideoEnabled;
        });
        toggleVideoBtn.textContent = isVideoEnabled ? "ã‚«ãƒ¡ãƒ©OFF" : "ã‚«ãƒ¡ãƒ©ON";
      }

      function hangup() {
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }

        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
        }

        localVideo.srcObject = null;
        remoteVideo.srcObject = null;
        outgoingSignal.value = "";
        incomingSignal.value = "";
        isAudioEnabled = true;
        isVideoEnabled = true;
        toggleAudioBtn.textContent = "ãƒã‚¤ã‚¯OFF";
        toggleVideoBtn.textContent = "ã‚«ãƒ¡ãƒ©OFF";

        setStatus("é€šè©±ã‚’åˆ‡æ–­ã—ã¾ã—ãŸã€‚å†é–‹ã™ã‚‹ã«ã¯ã‚«ãƒ¡ãƒ©é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
        updateButtons();
      }

      async function copySignal() {
        if (!outgoingSignal.value) {
          setStatus("ã‚³ãƒ”ãƒ¼ã§ãã‚‹ã‚·ã‚°ãƒŠãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", true);
          return;
        }

        try {
          await navigator.clipboard.writeText(outgoingSignal.value);
          setStatus("é€ä¿¡ç”¨ã‚·ã‚°ãƒŠãƒ«ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
        } catch (error) {
          setStatus("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚", true);
          console.error(error);
        }
      }

      startBtn.addEventListener("click", startMedia);
      createOfferBtn.addEventListener("click", createOffer);
      createAnswerBtn.addEventListener("click", createAnswer);
      applyBtn.addEventListener("click", applyIncomingSignal);
      toggleAudioBtn.addEventListener("click", toggleAudio);
      toggleVideoBtn.addEventListener("click", toggleVideo);
      hangupBtn.addEventListener("click", hangup);
      copyBtn.addEventListener("click", copySignal);

      updateButtons();
    </script>
  </body>
</html>
