<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚·ãƒ³ãƒ—ãƒ« ãƒ“ãƒ‡ã‚ªé€šè©±</title>
    <style>
      :root {
        --bg: #f8fafc;
        --panel: #ffffff;
        --text: #0f172a;
        --muted: #475569;
        --border: #dbe3ef;
        --primary: #2563eb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 16px;
        font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .app {
        max-width: 960px;
        margin: 0 auto;
        display: grid;
        gap: 12px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
      }

      h1 {
        margin: 0;
        font-size: clamp(20px, 3vw, 30px);
      }

      .note {
        margin: 8px 0 0;
        color: var(--muted);
        font-size: 14px;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      input {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 14px;
      }

      button {
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
        color: var(--text);
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
      }

      button.primary {
        background: var(--primary);
        border-color: #1d4ed8;
        color: white;
      }

      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .videos {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      video {
        width: 100%;
        aspect-ratio: 16 / 9;
        border: 1px solid #cbd5e1;
        border-radius: 10px;
        background: #0f172a;
        object-fit: cover;
      }

      .status {
        margin: 0;
        font-size: 14px;
        color: #16a34a;
      }
    </style>
  </head>
  <body>
    <main class="app">
      <section class="panel">
        <h1>ğŸ“¹ ã‚·ãƒ³ãƒ—ãƒ« ãƒ“ãƒ‡ã‚ªé€šè©±</h1>
        <p class="note">åŒã˜ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ã€åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¥ã‚¿ãƒ–ã§é–‹ãã¨æ¥ç¶šãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚</p>
      </section>

      <section class="panel">
        <div class="controls">
          <input id="roomInput" type="text" value="room-1" aria-label="ãƒ«ãƒ¼ãƒ ID" />
          <button id="startBtn" class="primary" type="button">1. ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
          <button id="joinBtn" class="primary" type="button" disabled>2. ãƒ«ãƒ¼ãƒ å‚åŠ </button>
          <button id="muteBtn" type="button" disabled>ãƒã‚¤ã‚¯OFF</button>
          <button id="camBtn" type="button" disabled>ã‚«ãƒ¡ãƒ©OFF</button>
          <button id="hangupBtn" type="button" disabled>åˆ‡æ–­</button>
        </div>
        <p id="status" class="status">æº–å‚™OK: ã¾ãšã€Œã‚«ãƒ¡ãƒ©é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
      </section>

      <section class="panel videos">
        <div>
          <strong>ã‚ãªãŸ</strong>
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div>
          <strong>ç›¸æ‰‹</strong>
          <video id="remoteVideo" autoplay playsinline></video>
        </div>
      </section>
    </main>

    <script>
      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const roomInput = document.getElementById("roomInput");
      const startBtn = document.getElementById("startBtn");
      const joinBtn = document.getElementById("joinBtn");
      const muteBtn = document.getElementById("muteBtn");
      const camBtn = document.getElementById("camBtn");
      const hangupBtn = document.getElementById("hangupBtn");
      const statusLabel = document.getElementById("status");

      const myId = crypto.randomUUID();
      const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

      let localStream = null;
      let pc = null;
      let channel = null;
      let remoteId = null;
      let isInitiator = false;
      let pendingCandidates = [];
      let audioOn = true;
      let videoOn = true;

      function setStatus(message, isError = false) {
        statusLabel.textContent = message;
        statusLabel.style.color = isError ? "#dc2626" : "#16a34a";
      }

      function updateButtons() {
        const hasStream = Boolean(localStream);
        const hasPc = Boolean(pc);
        startBtn.disabled = hasStream;
        joinBtn.disabled = !hasStream || Boolean(channel);
        muteBtn.disabled = !hasStream;
        camBtn.disabled = !hasStream;
        hangupBtn.disabled = !hasStream && !hasPc && !channel;
      }

      function send(message) {
        if (!channel) {
          return;
        }
        channel.postMessage({ ...message, from: myId, to: remoteId });
      }

      async function maybeCreateOffer() {
        if (!pc || !isInitiator || !remoteId || pc.signalingState !== "stable") {
          return;
        }
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        send({ type: "offer", sdp: pc.localDescription });
        setStatus("ã‚ªãƒ•ã‚¡ãƒ¼é€ä¿¡ä¸­...");
      }

      function ensurePeerConnection() {
        if (pc) {
          return;
        }

        pc = new RTCPeerConnection(rtcConfig);
        pendingCandidates = [];

        localStream.getTracks().forEach((track) => {
          pc.addTrack(track, localStream);
        });

        pc.addEventListener("track", (event) => {
          remoteVideo.srcObject = event.streams[0];
        });

        pc.addEventListener("icecandidate", (event) => {
          if (event.candidate) {
            send({ type: "candidate", candidate: event.candidate.toJSON() });
          }
        });

        pc.addEventListener("connectionstatechange", () => {
          if (pc.connectionState === "connected") {
            setStatus("æ¥ç¶šã§ãã¾ã—ãŸã€‚é€šè©±ä¸­ã§ã™ã€‚", false);
          } else if (pc.connectionState === "failed") {
            setStatus("æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ‡æ–­ã—ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚", true);
          }
        });
      }

      async function startCamera() {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localVideo.srcObject = localStream;
          setStatus("ã‚«ãƒ¡ãƒ©é–‹å§‹å®Œäº†ã€‚æ¬¡ã«ãƒ«ãƒ¼ãƒ å‚åŠ ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
          updateButtons();
        } catch (error) {
          setStatus("ã‚«ãƒ¡ãƒ©ãƒ»ãƒã‚¤ã‚¯ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", true);
          console.error(error);
        }
      }

      async function handleSignal(message) {
        if (message.from === myId) {
          return;
        }
        if (message.to && message.to !== myId) {
          return;
        }

        if (!remoteId) {
          remoteId = message.from;
          isInitiator = myId > remoteId;
          setStatus(`ç›¸æ‰‹ã‚’æ¤œå‡º: æ¥ç¶šæº–å‚™ä¸­ (${isInitiator ? "ç™ºä¿¡å´" : "å¿œç­”å´"})`);
        }

        ensurePeerConnection();

        if (message.type === "hello") {
          await maybeCreateOffer();
          return;
        }

        if (message.type === "offer") {
          await pc.setRemoteDescription(message.sdp);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          send({ type: "answer", sdp: pc.localDescription });

          for (const c of pendingCandidates) {
            await pc.addIceCandidate(c);
          }
          pendingCandidates = [];

          setStatus("ã‚ªãƒ•ã‚¡ãƒ¼å—ä¿¡â†’ã‚¢ãƒ³ã‚µãƒ¼é€ä¿¡ã—ã¾ã—ãŸã€‚");
          return;
        }

        if (message.type === "answer") {
          await pc.setRemoteDescription(message.sdp);
          for (const c of pendingCandidates) {
            await pc.addIceCandidate(c);
          }
          pendingCandidates = [];
          setStatus("ã‚¢ãƒ³ã‚µãƒ¼å—ä¿¡ã€‚æ¥ç¶šå¾…æ©Ÿä¸­...");
          return;
        }

        if (message.type === "candidate") {
          if (pc.remoteDescription) {
            await pc.addIceCandidate(message.candidate);
          } else {
            pendingCandidates.push(message.candidate);
          }
          return;
        }

        if (message.type === "leave") {
          remoteVideo.srcObject = null;
          setStatus("ç›¸æ‰‹ãŒåˆ‡æ–­ã—ã¾ã—ãŸã€‚", true);
        }
      }

      function joinRoom() {
        const roomId = roomInput.value.trim();
        if (!roomId) {
          setStatus("ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
          return;
        }

        channel = new BroadcastChannel(`webrtc-room-${roomId}`);
        channel.onmessage = async (event) => {
          try {
            await handleSignal(event.data);
          } catch (error) {
            setStatus("ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
            console.error(error);
          }
        };

        setStatus("ãƒ«ãƒ¼ãƒ å‚åŠ å®Œäº†ã€‚ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...");
        send({ type: "hello", to: null });
        updateButtons();
      }

      function toggleMute() {
        if (!localStream) {
          return;
        }
        audioOn = !audioOn;
        localStream.getAudioTracks().forEach((track) => {
          track.enabled = audioOn;
        });
        muteBtn.textContent = audioOn ? "ãƒã‚¤ã‚¯OFF" : "ãƒã‚¤ã‚¯ON";
      }

      function toggleCamera() {
        if (!localStream) {
          return;
        }
        videoOn = !videoOn;
        localStream.getVideoTracks().forEach((track) => {
          track.enabled = videoOn;
        });
        camBtn.textContent = videoOn ? "ã‚«ãƒ¡ãƒ©OFF" : "ã‚«ãƒ¡ãƒ©ON";
      }

      function hangup() {
        if (channel) {
          send({ type: "leave" });
          channel.close();
          channel = null;
        }

        if (pc) {
          pc.close();
          pc = null;
        }

        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
        }

        remoteVideo.srcObject = null;
        localVideo.srcObject = null;
        remoteId = null;
        isInitiator = false;
        pendingCandidates = [];
        audioOn = true;
        videoOn = true;
        muteBtn.textContent = "ãƒã‚¤ã‚¯OFF";
        camBtn.textContent = "ã‚«ãƒ¡ãƒ©OFF";
        setStatus("åˆ‡æ–­ã—ã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã›ã¾ã™ã€‚");
        updateButtons();
      }

      startBtn.addEventListener("click", startCamera);
      joinBtn.addEventListener("click", joinRoom);
      muteBtn.addEventListener("click", toggleMute);
      camBtn.addEventListener("click", toggleCamera);
      hangupBtn.addEventListener("click", hangup);

      updateButtons();
    </script>
  </body>
</html>
