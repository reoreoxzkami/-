<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãŠçµµã‹ãã‚¢ãƒ—ãƒª</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f4f7fb;
        --panel: #ffffff;
        --text: #1f2937;
        --border: #dbe3ef;
        --accent: #2563eb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .app {
        min-height: 100vh;
        display: grid;
        grid-template-rows: auto 1fr auto;
      }

      header,
      footer {
        padding: 16px 20px;
        background: var(--panel);
        border-bottom: 1px solid var(--border);
      }

      footer {
        border-top: 1px solid var(--border);
        border-bottom: none;
        font-size: 14px;
      }

      h1 {
        margin: 0;
        font-size: clamp(20px, 2.6vw, 30px);
      }

      main {
        display: grid;
        gap: 14px;
        align-content: start;
        padding: 16px;
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
      }

      .toolbar-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      button,
      input[type="range"],
      input[type="color"] {
        cursor: pointer;
      }

      button {
        border: 1px solid var(--border);
        background: white;
        color: var(--text);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 14px;
      }

      button.primary {
        background: var(--accent);
        color: white;
        border: 1px solid #1749b8;
      }

      .board-wrap {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        overflow: auto;
      }

      #board {
        display: block;
        width: min(100%, 1100px);
        height: min(72vh, 760px);
        touch-action: none;
        background: white;
        border-radius: 10px;
        border: 1px solid #d0d9e7;
      }

      .size-label {
        min-width: 70px;
        font-variant-numeric: tabular-nums;
      }

      .hint {
        margin-left: auto;
        font-size: 13px;
        color: #4b5563;
      }

      @media (max-width: 720px) {
        .hint {
          width: 100%;
          margin-left: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>ğŸ¨ ãŠçµµã‹ãã‚¢ãƒ—ãƒª</h1>
      </header>
      <main>
        <section class="toolbar" aria-label="æç”»ãƒ„ãƒ¼ãƒ«">
          <div class="toolbar-group">
            <label for="color">è‰²</label>
            <input id="color" type="color" value="#1f2937" />
          </div>
          <div class="toolbar-group">
            <label for="size">å¤ªã•</label>
            <input id="size" type="range" min="1" max="40" value="6" />
            <span class="size-label" id="sizeLabel">6px</span>
          </div>
          <div class="toolbar-group">
            <button id="penBtn" class="primary" type="button">ãƒšãƒ³</button>
            <button id="eraserBtn" type="button">æ¶ˆã—ã‚´ãƒ </button>
          </div>
          <div class="toolbar-group">
            <button id="undoBtn" type="button">1ã¤æˆ»ã™</button>
            <button id="clearBtn" type="button">å…¨æ¶ˆã—</button>
            <button id="downloadBtn" type="button">ç”»åƒã¨ã—ã¦ä¿å­˜</button>
          </div>
          <p class="hint">ãƒã‚¦ã‚¹ï¼ã‚¿ãƒƒãƒã§æç”»ã§ãã¾ã™ã€‚</p>
        </section>

        <section class="board-wrap">
          <canvas id="board" width="1100" height="760" aria-label="æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹"></canvas>
        </section>
      </main>
      <footer>ãƒ’ãƒ³ãƒˆ: è‰²ãƒ»å¤ªã•ã‚’å¤‰ãˆã¦è‡ªç”±ã«æã„ã¦ãã ã•ã„ã€‚</footer>
    </div>

    <script>
      const canvas = document.getElementById("board");
      const ctx = canvas.getContext("2d");
      const colorInput = document.getElementById("color");
      const sizeInput = document.getElementById("size");
      const sizeLabel = document.getElementById("sizeLabel");
      const penBtn = document.getElementById("penBtn");
      const eraserBtn = document.getElementById("eraserBtn");
      const undoBtn = document.getElementById("undoBtn");
      const clearBtn = document.getElementById("clearBtn");
      const downloadBtn = document.getElementById("downloadBtn");

      let drawing = false;
      let lastPoint = null;
      let isEraser = false;
      const history = [];
      const maxHistory = 30;

      function pushHistory() {
        if (history.length >= maxHistory) {
          history.shift();
        }
        history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
      }

      function setToolMode() {
        penBtn.classList.toggle("primary", !isEraser);
        eraserBtn.classList.toggle("primary", isEraser);
      }

      function getPointFromEvent(event) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
          x: (event.clientX - rect.left) * scaleX,
          y: (event.clientY - rect.top) * scaleY
        };
      }

      function drawLine(from, to) {
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.lineWidth = Number(sizeInput.value);
        ctx.strokeStyle = isEraser ? "#ffffff" : colorInput.value;
        ctx.beginPath();
        ctx.moveTo(from.x, from.y);
        ctx.lineTo(to.x, to.y);
        ctx.stroke();
      }

      function handlePointerDown(event) {
        event.preventDefault();
        drawing = true;
        lastPoint = getPointFromEvent(event);
        pushHistory();
      }

      function handlePointerMove(event) {
        if (!drawing) {
          return;
        }
        event.preventDefault();
        const current = getPointFromEvent(event);
        drawLine(lastPoint, current);
        lastPoint = current;
      }

      function stopDrawing() {
        drawing = false;
        lastPoint = null;
      }

      function clearCanvas() {
        pushHistory();
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      function undo() {
        if (history.length === 0) {
          return;
        }
        const image = history.pop();
        ctx.putImageData(image, 0, 0);
      }

      function downloadImage() {
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `oekaki-${Date.now()}.png`;
        link.click();
      }

      function resizeLabel() {
        sizeLabel.textContent = `${sizeInput.value}px`;
      }

      canvas.addEventListener("pointerdown", handlePointerDown);
      canvas.addEventListener("pointermove", handlePointerMove);
      window.addEventListener("pointerup", stopDrawing);
      window.addEventListener("pointercancel", stopDrawing);
      sizeInput.addEventListener("input", resizeLabel);

      penBtn.addEventListener("click", () => {
        isEraser = false;
        setToolMode();
      });

      eraserBtn.addEventListener("click", () => {
        isEraser = true;
        setToolMode();
      });

      undoBtn.addEventListener("click", undo);
      clearBtn.addEventListener("click", clearCanvas);
      downloadBtn.addEventListener("click", downloadImage);

      clearCanvas();
      resizeLabel();
      setToolMode();
    </script>
  </body>
</html>
