<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Video Generator (Replicate + Vercel)</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #0b1020;
        --card: #141a2b;
        --text: #e9ecf4;
        --muted: #99a2ba;
        --accent: #6d8dff;
        --accent-hover: #5c7df8;
        --danger: #ff6b6b;
        --border: #2a324b;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Inter, system-ui, -apple-system, sans-serif;
        background: radial-gradient(circle at 20% 10%, #1c2644 0, var(--bg) 35%);
        color: var(--text);
        min-height: 100vh;
      }

      .container {
        width: min(960px, 92%);
        margin: 2.5rem auto;
        display: grid;
        gap: 1rem;
      }

      .card {
        background: color-mix(in hsl, var(--card) 90%, black);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 1rem;
      }

      h1, h2 { margin: 0 0 .75rem; }
      p { color: var(--muted); margin-top: 0; }

      .grid {
        display: grid;
        gap: 0.75rem;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      label {
        display: flex;
        flex-direction: column;
        gap: .4rem;
        font-size: .92rem;
      }

      input, select, button, textarea {
        background: #0f1527;
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 10px;
        padding: .7rem .8rem;
        font-size: 0.95rem;
      }

      textarea {
        min-height: 110px;
        resize: vertical;
      }

      button {
        cursor: pointer;
        background: var(--accent);
        border: none;
        font-weight: 600;
      }
      button:hover { background: var(--accent-hover); }
      button:disabled { opacity: .65; cursor: wait; }

      .status {
        min-height: 1.3rem;
        color: var(--muted);
      }

      .status.error { color: var(--danger); }

      .result video {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        margin-top: .7rem;
      }

      .history-list {
        margin: 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: .75rem;
      }

      .history-item {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: .75rem;
        display: grid;
        gap: .5rem;
      }

      .meta {
        display: flex;
        gap: .75rem;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: .86rem;
      }

      .actions {
        display: flex;
        gap: .6rem;
        flex-wrap: wrap;
      }

      .secondary {
        background: #222b43;
      }

      .empty {
        color: var(--muted);
      }

      .footer { color: var(--muted); font-size: .85rem; text-align: center; }
    </style>
  </head>
  <body>
    <main class="container">
      <section class="card">
        <h1>ğŸ¬ AI Video Generator</h1>
        <p>Replicate ã® zeroscope-v2 ã‚’ä½¿ã£ã¦ã€ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å‹•ç”»ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>

        <form id="videoForm">
          <label>
            ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            <textarea id="prompt" required placeholder="ä¾‹: cinematic drone shot of neon Tokyo street in rainy night"></textarea>
          </label>

          <div class="grid">
            <label>
              è§£åƒåº¦
              <select id="resolution">
                <option value="576x320">576x320 (é«˜é€Ÿ)</option>
                <option value="768x432">768x432 (æ¨™æº–)</option>
                <option value="1024x576">1024x576 (é«˜ç”»è³ª)</option>
              </select>
            </label>

            <label>
              ç§’æ•°
              <input id="seconds" type="number" min="1" max="8" value="3" required />
            </label>

            <label>
              Seedï¼ˆä»»æ„ï¼‰
              <input id="seed" type="number" min="0" placeholder="ä¾‹: 12345" />
            </label>
          </div>

          <div class="actions" style="margin-top: .8rem;">
            <button id="generateBtn" type="submit">Generate</button>
            <button id="clearHistoryBtn" class="secondary" type="button">å±¥æ­´ã‚’å‰Šé™¤</button>
          </div>
        </form>

        <p id="status" class="status"></p>
      </section>

      <section class="card result" id="resultSection" hidden>
        <h2>ç”Ÿæˆçµæœ</h2>
        <a id="downloadLink" class="secondary" style="display:inline-block; text-decoration:none;" download>å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
        <video id="videoPreview" controls playsinline></video>
      </section>

      <section class="card">
        <h2>å±¥æ­´ï¼ˆlocalStorageï¼‰</h2>
        <ul id="historyList" class="history-list"></ul>
        <p id="emptyHistory" class="empty">ã¾ã å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      </section>

      <p class="footer">Built with Vercel Serverless Functions + Replicate API</p>
    </main>

    <script>
      const form = document.getElementById('videoForm');
      const promptEl = document.getElementById('prompt');
      const resolutionEl = document.getElementById('resolution');
      const secondsEl = document.getElementById('seconds');
      const seedEl = document.getElementById('seed');
      const statusEl = document.getElementById('status');
      const generateBtn = document.getElementById('generateBtn');
      const resultSection = document.getElementById('resultSection');
      const preview = document.getElementById('videoPreview');
      const downloadLink = document.getElementById('downloadLink');
      const historyList = document.getElementById('historyList');
      const emptyHistory = document.getElementById('emptyHistory');
      const clearHistoryBtn = document.getElementById('clearHistoryBtn');

      const HISTORY_KEY = 'ai-video-history-v1';

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.classList.toggle('error', isError);
      }

      function loadHistory() {
        try {
          return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
        } catch {
          return [];
        }
      }

      function saveHistory(history) {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 10)));
      }

      function renderHistory() {
        const history = loadHistory();
        historyList.innerHTML = '';
        emptyHistory.hidden = history.length > 0;

        history.forEach((item) => {
          const li = document.createElement('li');
          li.className = 'history-item';

          li.innerHTML = `
            <strong>${item.prompt}</strong>
            <div class="meta">
              <span>è§£åƒåº¦: ${item.resolution}</span>
              <span>ç§’æ•°: ${item.seconds}s</span>
              <span>Seed: ${item.seed || 'auto'}</span>
              <span>${new Date(item.createdAt).toLocaleString()}</span>
            </div>
            <div class="actions">
              <button type="button" class="secondary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
              <a href="${item.url}" download style="text-decoration:none;" class="secondary">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
            </div>
          `;

          li.querySelector('button').addEventListener('click', () => {
            showResult(item.url);
          });

          historyList.appendChild(li);
        });
      }

      function addHistory(entry) {
        const history = loadHistory();
        history.unshift(entry);
        saveHistory(history);
        renderHistory();
      }

      function showResult(url) {
        preview.src = url;
        downloadLink.href = url;
        downloadLink.setAttribute('download', `generated-video-${Date.now()}.mp4`);
        resultSection.hidden = false;
      }

      clearHistoryBtn.addEventListener('click', () => {
        localStorage.removeItem(HISTORY_KEY);
        renderHistory();
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const payload = {
          prompt: promptEl.value.trim(),
          resolution: resolutionEl.value,
          seconds: Number(secondsEl.value),
          seed: seedEl.value ? Number(seedEl.value) : undefined,
        };

        if (!payload.prompt) {
          setStatus('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', true);
          return;
        }

        generateBtn.disabled = true;
        setStatus('ç”Ÿæˆä¸­ã§ã™ã€‚é€šå¸¸ 30 ç§’ã€œæ•°åˆ†ã‹ã‹ã‚Šã¾ã™...');

        try {
          const response = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || 'å‹•ç”»ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }

          showResult(data.videoUrl);
          addHistory({ ...payload, url: data.videoUrl, createdAt: Date.now() });
          setStatus('ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        } catch (error) {
          setStatus(error.message, true);
        } finally {
          generateBtn.disabled = false;
        }
      });

      renderHistory();
    </script>
  </body>
</html>
